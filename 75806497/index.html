<!doctype html>
<html>
  <head>
      <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
  </head>
  <body>
    <button>Analyze input</button>
    <script type="text/javascript">

      // Check if handle exists inside directory our directory handle
      async function inDirectory(directoryHandle, fileHandle) {
        return await directoryHandle.resolve(fileHandle) === null;
      }

      async function main() {
        const dirHandle = await showDirectoryPicker();
        const [fileHandle] = await showOpenFilePicker();
        const bad = await inDirectory(dirHandle, fileHandle);
        if (bad) {
          throw Error("The file is not in the mounted directory");
          return;
        }

        const fileData = await fileHandle.getFile();
        console.log(fileData.name);
          if ((await fileHandle.queryPermission({ mode: "readwrite" })) !== "granted") {
              if (
                  (await fileHandle.requestPermission({ mode: "readwrite" })) !== "granted"
              ) {
                  throw Error("Unable to read and write directory");
              }
          }
          let pyodide = await loadPyodide();
          const nativefs = await pyodide.mountNativeFS("/mount_dir", dirHandle);

          pyodide.runPython(`
            import os
            print(os.listdir('/mount_dir'))
            print(open('/mount_dir/${fileData.name}').read())
          `);
      }

      const button = document.querySelector('button');
      button.addEventListener('click', main);
    </script>
  </body>
</html>
